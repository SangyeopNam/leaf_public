<!doctype html><html lang=ko dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Java]Spring Security(With TDD) JWT 구현하기 | 봄을 기다리는 낙엽</title>
<meta name=keywords content="authentication,jwt"><meta name=description content="JWT를 통한 인증을 직접 구현합니다."><meta name=author content="Leaf"><link rel=canonical href=http://localhost:1313/posts/spring_security/5/><meta name=google-site-verification content="l76eAEMadEn1QzS8fLTbrl8ppayZprvV3uuAbMGSy_c"><meta name=msvalidate.01 content="XYZabc"><meta name=naver-site-verification content="adff811404d441495a954e30579f40297ba14f5e"><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/icon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/icon/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/icon/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ko href=http://localhost:1313/posts/spring_security/5/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9PNFP00SSG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9PNFP00SSG")}</script><meta property="og:url" content="http://localhost:1313/posts/spring_security/5/"><meta property="og:site_name" content="봄을 기다리는 낙엽"><meta property="og:title" content="[Java]Spring Security(With TDD) JWT 구현하기"><meta property="og:description" content="JWT를 통한 인증을 직접 구현합니다."><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-09T22:01:51+09:00"><meta property="article:modified_time" content="2024-12-09T22:01:51+09:00"><meta property="article:tag" content="Authentication"><meta property="article:tag" content="Jwt"><meta property="og:image" content="http://localhost:1313/posts/spring_security/5/test_coverage.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/posts/spring_security/5/test_coverage.png"><meta name=twitter:title content="[Java]Spring Security(With TDD) JWT 구현하기"><meta name=twitter:description content="JWT를 통한 인증을 직접 구현합니다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Spring Security 파헤치기","item":"http://localhost:1313/posts/spring_security/"},{"@type":"ListItem","position":3,"name":"[Java]Spring Security(With TDD) JWT 구현하기","item":"http://localhost:1313/posts/spring_security/5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Java]Spring Security(With TDD) JWT 구현하기","name":"[Java]Spring Security(With TDD) JWT 구현하기","description":"JWT를 통한 인증을 직접 구현합니다.","keywords":["authentication","jwt"],"articleBody":"도입 지난 포스팅 [Java]Spring Security WebMVC 기본 구조 [Java]Spring Security 예외처리, 캐싱, 로깅 [Java]Spring Security 인증(Authentication)과 인가(Authorization) [Java]Spring Security(With TDD) 기본 인증 및 인가 구현하기 지금까지 Spring Security의 기본 개념을 학습하고, 기본 인증 및 인가를 구현했습니다.\n이번 시간에는 JWT의 기본 개념을 익히고, 프로젝트에 인증 및 인가 로직에 활용해보겠습니다.\nJWT JWT는 JSON Web Token의 준말로 RFC 7519 명세에 정의된 토큰입니다.\n위 명세에 따르면, JWT는 다음과 같이 정의할 수 있습니다. JSON Web Token (JWT)는 두 당사자 간에 전송되는 클레임(claims)을 표현하기 위한 간결하고 URL에 안전한 수단입니다. JWT의 클레임은 JSON 객체로 인코딩되며, 이는 JSON Web Signature (JWS) 구조의 페이로드(payload)로 사용되거나 JSON Web Encryption (JWE) 구조의 평문(plaintext)으로 사용됩니다. 이를 통해 클레임은 디지털 서명되거나 메시지 인증 코드(Message Authentication Code, MAC)를 사용하여 무결성이 보호되거나 암호화될 수 있습니다.\n이러한 JWT 인증의 장단점을 살펴보면 다음과 같습니다.\n장점\nstateless1한 특성이 있어 서버 부담을 줄일 수 있습니다.\n서버에 사용자의 정보들을 별도로 저장하지 않고도, JWT를 복호화함으로써 인증된 사용자임을 바로 파악할 수 있기 때문입니다.\nCookie 저장소2를 지원하지 않는 등 기존의 Session - Cookie 방식을 사용할 수 없는 환경에서도 인증이 가능합니다.\n프론트엔드와 백엔드가 분리된 아키텍쳐로 개발되는 현대 웹앱에 적합한 형태입니다.\n특히, 백엔드 서버가 Scale Out3이나 MSA4 등으로 구조가 복잡해지면 필연적으로 인증 동기화의 어려움을 겪는데, JWT를 활용하면 토큰 유효성만 검사하면 되기 때문에 이러한 문제를 쉽게 해결할 수 있습니다.\n단점\n해당 방식을 사용하려면 프론트엔드에서 JWT를 어딘가에 보관했다가 요청 시 함께 전송해야 하는데, 이러한 과정에서 토큰을 탈취당할 수 있습니다.\n토큰 탈취를 막기 위해 Refresh Token5을 도입할 수 있지만, 이를 저장 및 검증하는 과정에서 추가적인 서버 부하가 발생합니다.\n인코딩되는 토큰의 길이가 길기 때문에, 토큰 전송 과정에서 네트워크 부하가 발생합니다.\nPayload(Body)에 담기는 정보는 암호화되지 않기 때문에, 중요하거나 취약한 정보를 담을 수 없습니다.\nSession - Cookie의 장단점은 JWT와 정반대라고 생각하시면 되겠습니다. Session - Cookie 방식을 사용할지 JWT를 사용할지는 요구사항에 따라 다를 수 있으니, 장단점을 따져보고 취사선택 하시면 되겠습니다.\n설계 JWT 의존성 추가 다음과 같이 build.gradle에 JWT 파싱을 위한 라이브러리를 추가해줍니다.\n// for jjwt implementation 'io.jsonwebtoken:jjwt-api:0.12.6' implementation 'io.jsonwebtoken:jjwt-impl:0.12.6' implementation 'io.jsonwebtoken:jjwt-jackson:0.12.6' 저는 jjwt를 사용하겠습니다. 다양한 라이브러리가 있지만, 대부분 기능은 유사하니 사용이 편한 라이브러리를 사용하시면 되겠습니다.\n요구사항 분석 JWT를 사용해서 달성하려는 요구사항을 정리해보면 다음과 같습니다.\n로그인 실패 시 jwt를 발행하지 않는다. 정상 로그인 시 jwt를 발행한다.(Happy Case) 잘못된 jwt로 인증할 수 없다. 권한이 부족한 jwt에 인가할 수 없다. 정상적인 jwt로 특정 권한의 api를 사용할 수 있다.(Happy Case) 통합테스트 작성 package com.springsecurity.jwt.integration; import com.springsecurity.jwt.api.ApiController; import com.springsecurity.jwt.utility.JwtUtil; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.DisplayName; import org.junit.jupiter.api.Test; import org.junit.jupiter.api.extension.ExtendWith; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.context.annotation.Import; import org.springframework.http.HttpHeaders; import org.springframework.test.context.ContextConfiguration; import org.springframework.test.context.junit.jupiter.SpringExtension; import org.springframework.test.context.web.WebAppConfiguration; import org.springframework.test.web.servlet.MockMvc; import org.springframework.test.web.servlet.setup.MockMvcBuilders; import org.springframework.web.context.WebApplicationContext; import static org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.springSecurity; import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*; import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*; @ExtendWith(SpringExtension.class) @ContextConfiguration(classes = SecurityConfig.class) @WebAppConfiguration @Import(ApiController.class) public class JWTIntegrationTest { MockMvc mockMvc; JwtUtil jwtUtil; @Autowired WebApplicationContext context; @BeforeEach void init() { mockMvc = MockMvcBuilders.webAppContextSetup(context) .apply(springSecurity()).build(); } @Test @DisplayName(\"1. 로그인 실패 시 jwt를 발행하지 않는다.\") void testLoginFailure() throws Exception { // given : 정상 아이디와 잘못된 패스워드 String id = \"user\"; String password = \"badPassword\"; // when : 토큰 발급 시도 mockMvc.perform(post(\"/jwt/token\") .param(\"username\", id) .param(\"password\", password)) // then : 401(Unauthenticated) 오류 .andExpect(status().is(401)); } @Test @DisplayName(\"2. 정상 로그인 시 jwt를 발행한다.(Happy Case)\") void testLoginSuccess() throws Exception { // given : 정상 아이디, 패스워드 String id = \"user\"; String password = \"user1234\"; // when : 토큰 발급 String token = mockMvc.perform(post(\"/jwt/token\") .param(\"username\", id) .param(\"password\", password)) .andExpect(status().is(200)) .andReturn().getResponse().getContentAsString(); // then : 정상 토큰여부 확인(JwtUtil) jwtUtil.validate(token); } @Test @DisplayName(\"3. 잘못된 jwt로 인증할 수 없다.\") void testAuthentication() throws Exception { // given : 잘못된 jwt 토큰 String badToken = \"bearer asdf1234\"; // when : User API 접근 mockMvc.perform(get(\"/user/resources\") .header(HttpHeaders.AUTHORIZATION, badToken)) // then : 401 오류 .andExpect(status().is(401)); } @Test @DisplayName(\"4. 권한이 부족한 jwt에 인가할 수 없다.\") void testAuthorization() throws Exception { // given : User JWT 획득 String id = \"user\"; String password = \"user1234\"; String userToken = mockMvc.perform(post(\"/jwt/token\") .param(\"username\", id) .param(\"password\", password)) .andExpect(status().is(200)) .andReturn().getResponse().getContentAsString(); // when : Admin API 접근 mockMvc.perform(get(\"/admin/resources\") .header(HttpHeaders.AUTHORIZATION, \"Bearer \" + userToken)) // then : 403(Forbidden) 오류 .andExpect(status().is(403)); } @Test @DisplayName(\"5. 정상적인 jwt로 특정 권한의 api를 사용할 수 있다.`(Happy Case)`\") void testHappyCase() throws Exception { // given : Admin JWT 획득 String id = \"admin\"; String password = \"admin1234\"; String userToken = mockMvc.perform(post(\"/jwt/token\") .param(\"username\", id) .param(\"password\", password)) .andExpect(status().is(200)) .andReturn().getResponse().getContentAsString(); // when : Admin API 접근 mockMvc.perform(get(\"/admin/resources\") .header(HttpHeaders.AUTHORIZATION, \"Bearer \" + userToken)) // then : Admin 자원 획득 .andExpect(status().is(200)) .andExpect(content().string(\"ADMIN 자원 획득\")); } } 위 통합테스트를 작성하면서, 기존에 없던 JWTUtil이라는 클래스를 임시로 만들었습니다.\nTDD를 하는 만큼 테스트 과정에서 필요한 클래스는 그때그때 만들면서 대응하는 것이 좋습니다.\n아직 세부사항은 전혀 구현되지 않았으나, 일단은 테스트를 실행할 수 있도록 컴파일 오류를 해결하기 위해 다음과 utility 패키지를 만들고, JwtUtil 클래스를 생성합니다.\npackage com.springsecurity.jwt.utility; public class JwtUtil { public void validate(String token) { } } 통합테스트를 실행하면 다음과 같이 4개의 테스트가 실패합니다.\nJwtUtil 단위테스트 작성 우선, 임시로 만든 JwtUtil클래스의 기능을 채우기 위해 단위테스트를 작성하겠습니다.\n처음에는 어색할 수 있지만, 테스트를 먼저 작성하고 구현하는 것에 익숙해져야 합니다.\n이를 위해 요구사항을 분석하자면 다음과 같습니다. 유효하지 않은 토큰 검증 시 런타임 오류를 반환한다. 유효한 토큰 검증 시 오류가 발생하지 않는다.(Happy Case) 잘못된 권한의 토큰 발급 시 런타임 오류를 반환한다. 사용자 권한별 정상적인 토큰을 발급한다.(Happy Case) 유효하지 않은 토큰 파싱 시 런타임 오류를 반환한다. 정상적인 토큰을 파싱한다.(Happy Case) 토큰 검증 뿐 아니라, 토큰 API에서 사용할 권한별 토큰을 만드는 로직과 파싱하는 로직을 포함시켰습니다.\npackage com.springsecurity.jwt.utility; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.DisplayName; import org.junit.jupiter.api.Test; import static org.assertj.core.api.Assertions.*; class JwtUtilTest { JwtUtil suit; // JWT 형식이 아닌 토큰 String invalidToken1 = \"INVALIDATE_TOKEN\"; // https://jwt.io 에서 만든 예제 토큰 String invalidToken2 = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\"; // sub : admin, role : admin 이지만 유효하지 않은 secret key 를 사용한 토큰 String invalidToken3 = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiJ9.wpTc_a19-bJNZ7oeYghAmxks3tk2mjcP6xTqYe2u86c\"; @BeforeEach void init() { suit = new JwtUtil(); } @Test @DisplayName(\"1. 유효하지 않은 토큰 검증 시 런타임 오류를 반환한다.\") void testInvalidateToken() { assertThatThrownBy(() -\u003e suit.validate(invalidToken1)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.validate(invalidToken2)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.validate(invalidToken3)) .isInstanceOf(RuntimeException.class); } @Test @DisplayName(\"2. 유효한 토큰 검증 시 오류가 발생하지 않는다.(Happy Case)\") void testValidateToken() { // sub : admin, role : admin, 유효한 secret key 를 사용한 토큰 String validToken = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsInJvbGUiOiJBRE1JTiJ9.JPTeQnDLHeqqF2phvhfh_29tLucdzGWBDEeDyJhnmdk\"; suit.validate(validToken); } @Test @DisplayName(\"3. 잘못된 권한의 토큰 발급 시 런타임 오류를 반환한다.\") void testIllegalRoleIssue() { String userName = \"test_user\"; String role = \"ILLEGAL_ROLE\"; assertThatThrownBy(() -\u003e suit.issue(userName, role)) .isInstanceOf(RuntimeException.class); } @Test @DisplayName(\"4. 사용자 권한별 정상적인 토큰을 발급한다.(Happy Case)\") void testLegalRoleIssue() { // given String userName = \"user\"; String userRole = \"USER\"; String adminName = \"admin\"; String adminRole = \"ADMIN\"; // when String userToken = suit.issue(userName, userRole); String adminToken = suit.issue(adminName, adminRole); // then suit.validate(userToken); suit.validate(adminToken); } @Test @DisplayName(\"5. 유효하지 않은 토큰 파싱 시 런타임 오류를 반환한다.\") void testIllegalTokenParse() { assertThatThrownBy(() -\u003e suit.parseName(invalidToken1)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.parseName(invalidToken2)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.parseName(invalidToken3)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.parseRole(invalidToken1)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.parseRole(invalidToken2)) .isInstanceOf(RuntimeException.class); assertThatThrownBy(() -\u003e suit.parseRole(invalidToken3)) .isInstanceOf(RuntimeException.class); } @Test @DisplayName(\"6. 정상적인 토큰을 파싱한다.(Happy Case)\") void testLegalTokenParse() { // given String userName = \"user\"; String userRole = \"USER\"; String userToken = suit.issue(userName, userRole); // when String name = suit.parseName(userToken); String role = suit.parseRole(userToken); // then assertThat(name).isEqualTo(userName); assertThat(role).isEqualTo(userRole); } } 해시알고리즘과 같은 훨씬 구체적인 보안 요구사항이 있을 수 있지만, 예제인 만큼 전반적인 JWT의 동작 방식을 이해하는 것에 집중하겠습니다.\n구현 구현은 우선 단위테스트를 모두 성공한 후, 통합테스트를 완성시키는 순서로 진행하겠습니다.\nJWTUtil 구현 우선 테스트를 실행하기 위해 다음과 같이 JwtUtil을 수정합니다.\npackage com.springsecurity.jwt.utility; public class JwtUtil { public void validate(String token) { } public String issue(String userName, String Role) { return null; } public String parseRole(String token) { return null; } public String parseName(String userToken) { return null; } } 이후 단위테스트 결과는 다음과 같습니다.\n우선 토큰 검증부터 차근차근 구현해 보겠습니다.\n토큰 검증을 위해서 맨 처음에 추가했던 jjwt 라이브러리를 활용하겠습니다.\njjwt 깃허브의 Readme를 참고해서 다음과 같이 토큰을 검증하도록 했습니다.\n// JwtUtil.java /* 생략 */ public void validate(String token) { Jwts.parser() .verifyWith(secretKey()) .build() .parseSignedClaims(token); } private SecretKey secretKey() { // https://randomkeygen.com/ 에서 생성한 504-bit WPA Key return Keys.hmacShaKeyFor(\"+*jhLeu04kw7M~tQew","wordCount":"2156","inLanguage":"ko","image":"http://localhost:1313/posts/spring_security/5/test_coverage.png","datePublished":"2024-12-09T22:01:51+09:00","dateModified":"2024-12-09T22:01:51+09:00","author":{"@type":"Person","name":"Leaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/spring_security/5/"},"publisher":{"@type":"Organization","name":"봄을 기다리는 낙엽","logo":{"@type":"ImageObject","url":"http://localhost:1313/icon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="LEAF (Alt + H)">LEAF</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/concept/ title=개념정리><span>개념정리</span></a></li><li><a href=http://localhost:1313/search/ title=검색><span>검색</span></a></li><li><a href=http://localhost:1313/posts/ title=게시글><span>게시글</span></a></li><li><a href=http://localhost:1313/tips/ title=미세팁><span>미세팁</span></a></li><li><a href=http://localhost:1313/archives/ title=아카이브><span>아카이브</span></a></li><li><a href=http://localhost:1313/cote/ title=알고리즘><span>알고리즘</span></a></li><li><a href=http://localhost:1313/review/ title="책 리뷰"><span>책 리뷰</span></a></li><li><a href=http://localhost:1313/categories/ title=카테고리><span>카테고리</span></a></li><li><a href=http://localhost:1313/tags/ title=태그><span>태그</span></a></li><li><a href=https://github.com/leaf-nam/blog title=Git><span>Git</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>홈</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/spring_security/>Spring Security 파헤치기</a></div><h1 class="post-title entry-hint-parent">[Java]Spring Security(With TDD) JWT 구현하기</h1><div class=post-description>JWT를 통한 인증을 직접 구현합니다.</div><div class=post-meta><span title='2024-12-09 22:01:51 +0900 KST'>2024. 12. 9.</span>&nbsp;·&nbsp;11 분&nbsp;·&nbsp;2156 단어&nbsp;·&nbsp;Leaf&nbsp;|&nbsp;<a href=https://github.com/leaf-nam/blog/blob/main/content//posts/spring_security/5/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>목차</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#도입>도입</a><ul><li><a href=#지난-포스팅>지난 포스팅</a></li><li><a href=#jwt>JWT</a></li></ul></li><li><a href=#설계>설계</a><ul><li><a href=#jwt-의존성-추가>JWT 의존성 추가</a></li><li><a href=#요구사항-분석>요구사항 분석</a></li><li><a href=#통합테스트-작성>통합테스트 작성</a></li><li><a href=#jwtutil-단위테스트-작성>JwtUtil 단위테스트 작성</a></li></ul></li><li><a href=#구현>구현</a><ul><li><a href=#jwtutil-구현>JWTUtil 구현</a></li><li><a href=#token-api-구현>Token API 구현</a></li><li><a href=#authentication-구현>Authentication 구현</a></li></ul></li><li><a href=#결론>결론</a><ul><li><a href=#다음-포스팅>다음 포스팅</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=도입>도입<a hidden class=anchor aria-hidden=true href=#도입>#</a></h2><h3 id=지난-포스팅>지난 포스팅<a hidden class=anchor aria-hidden=true href=#지난-포스팅>#</a></h3><ul><li><a href=https://1eaf.site/posts/spring_security/1>[Java]Spring Security WebMVC 기본 구조</a></li><li><a href=https://1eaf.site/posts/spring_security/2>[Java]Spring Security 예외처리, 캐싱, 로깅</a></li><li><a href=https://1eaf.site/posts/spring_security/3>[Java]Spring Security 인증(Authentication)과 인가(Authorization)</a></li><li><a href=https://1eaf.site/posts/spring_security/4>[Java]Spring Security(With TDD) 기본 인증 및 인가 구현하기</a></li></ul><p>지금까지 Spring Security의 기본 개념을 학습하고, 기본 인증 및 인가를 구현했습니다.</p><p>이번 시간에는 JWT의 기본 개념을 익히고, 프로젝트에 인증 및 인가 로직에 활용해보겠습니다.</p><h3 id=jwt>JWT<a hidden class=anchor aria-hidden=true href=#jwt>#</a></h3><p>JWT는 JSON Web Token의 준말로 <a href=https://datatracker.ietf.org/doc/html/rfc7519>RFC 7519</a> 명세에 정의된 토큰입니다.</p><ul><li>위 명세에 따르면, JWT는 다음과 같이 정의할 수 있습니다.</li></ul><p><code>JSON Web Token (JWT)는 두 당사자 간에 전송되는 클레임(claims)을 표현하기 위한 간결하고 URL에 안전한 수단입니다. JWT의 클레임은 JSON 객체로 인코딩되며, 이는 JSON Web Signature (JWS) 구조의 페이로드(payload)로 사용되거나 JSON Web Encryption (JWE) 구조의 평문(plaintext)으로 사용됩니다. 이를 통해 클레임은 디지털 서명되거나 메시지 인증 코드(Message Authentication Code, MAC)를 사용하여 무결성이 보호되거나 암호화될 수 있습니다.</code></p><p>이러한 JWT 인증의 장단점을 살펴보면 다음과 같습니다.</p><ul><li><p><strong>장점</strong></p><ol><li><p><code>stateless</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>한 특성이 있어 서버 부담을 줄일 수 있습니다.</p><blockquote><p>서버에 사용자의 정보들을 별도로 저장하지 않고도, JWT를 복호화함으로써 인증된 사용자임을 바로 파악할 수 있기 때문입니다.</p></blockquote></li><li><p><code>Cookie 저장소</code><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>를 지원하지 않는 등 기존의 <code>Session - Cookie 방식</code>을 사용할 수 없는 환경에서도 인증이 가능합니다.</p></li><li><p>프론트엔드와 백엔드가 분리된 아키텍쳐로 개발되는 현대 웹앱에 적합한 형태입니다.</p><blockquote><p>특히, 백엔드 서버가 <code>Scale Out</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>이나 <code>MSA</code><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> 등으로 구조가 복잡해지면 필연적으로 인증 동기화의 어려움을 겪는데, JWT를 활용하면 토큰 유효성만 검사하면 되기 때문에 이러한 문제를 쉽게 해결할 수 있습니다.</p></blockquote></li></ol></li><li><p><strong>단점</strong></p><ol><li><p>해당 방식을 사용하려면 프론트엔드에서 JWT를 어딘가에 보관했다가 요청 시 함께 전송해야 하는데, 이러한 과정에서 토큰을 탈취당할 수 있습니다.</p></li><li><p>토큰 탈취를 막기 위해 <code>Refresh Token</code><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>을 도입할 수 있지만, 이를 저장 및 검증하는 과정에서 추가적인 서버 부하가 발생합니다.</p></li><li><p>인코딩되는 토큰의 길이가 길기 때문에, 토큰 전송 과정에서 네트워크 부하가 발생합니다.</p></li><li><p>Payload(Body)에 담기는 정보는 암호화되지 않기 때문에, 중요하거나 취약한 정보를 담을 수 없습니다.</p></li></ol></li></ul><blockquote><p><code>Session - Cookie</code>의 장단점은 <code>JWT</code>와 정반대라고 생각하시면 되겠습니다. <code>Session - Cookie</code> 방식을 사용할지 <code>JWT</code>를 사용할지는 요구사항에 따라 다를 수 있으니, 장단점을 따져보고 취사선택 하시면 되겠습니다.</p></blockquote><h2 id=설계>설계<a hidden class=anchor aria-hidden=true href=#설계>#</a></h2><h3 id=jwt-의존성-추가>JWT 의존성 추가<a hidden class=anchor aria-hidden=true href=#jwt-의존성-추가>#</a></h3><p>다음과 같이 <code>build.gradle</code>에 <a href=https://github.com/jwtk/jjwt>JWT 파싱을 위한 라이브러리</a>를 추가해줍니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl>  <span class=c1>// for jjwt
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>implementation</span> <span class=s1>&#39;io.jsonwebtoken:jjwt-api:0.12.6&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>implementation</span> <span class=s1>&#39;io.jsonwebtoken:jjwt-impl:0.12.6&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>implementation</span> <span class=s1>&#39;io.jsonwebtoken:jjwt-jackson:0.12.6&#39;</span>
</span></span></code></pre></div><p><img alt="JWT 의존성 추가" loading=lazy src=/posts/spring_security/5/build_gradle.png></p><blockquote><p>저는 jjwt를 사용하겠습니다. 다양한 라이브러리가 있지만, 대부분 기능은 유사하니 사용이 편한 라이브러리를 사용하시면 되겠습니다.</p></blockquote><h3 id=요구사항-분석>요구사항 분석<a hidden class=anchor aria-hidden=true href=#요구사항-분석>#</a></h3><p>JWT를 사용해서 달성하려는 요구사항을 정리해보면 다음과 같습니다.</p><ol><li>로그인 실패 시 jwt를 발행하지 않는다.</li><li>정상 로그인 시 jwt를 발행한다.<code>(Happy Case)</code></li><li>잘못된 jwt로 인증할 수 없다.</li><li>권한이 부족한 jwt에 인가할 수 없다.</li><li>정상적인 jwt로 특정 권한의 api를 사용할 수 있다.<code>(Happy Case)</code></li></ol><h3 id=통합테스트-작성>통합테스트 작성<a hidden class=anchor aria-hidden=true href=#통합테스트-작성>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.integration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.springsecurity.jwt.api.ApiController</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.springsecurity.jwt.utility.JwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.BeforeEach</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.DisplayName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.Test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.extension.ExtendWith</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Import</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.http.HttpHeaders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.test.context.ContextConfiguration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.test.context.junit.jupiter.SpringExtension</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.test.context.web.WebAppConfiguration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.test.web.servlet.MockMvc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.test.web.servlet.setup.MockMvcBuilders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.context.WebApplicationContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.springSecurity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>org.springframework.test.web.servlet.result.MockMvcResultMatchers.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ExtendWith</span><span class=p>(</span><span class=n>SpringExtension</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ContextConfiguration</span><span class=p>(</span><span class=n>classes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SecurityConfig</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@WebAppConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Import</span><span class=p>(</span><span class=n>ApiController</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JWTIntegrationTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MockMvc</span><span class=w> </span><span class=n>mockMvc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JwtUtil</span><span class=w> </span><span class=n>jwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WebApplicationContext</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@BeforeEach</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MockMvcBuilders</span><span class=p>.</span><span class=na>webAppContextSetup</span><span class=p>(</span><span class=n>context</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>springSecurity</span><span class=p>()).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;1. 로그인 실패 시 jwt를 발행하지 않는다.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testLoginFailure</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given : 정상 아이디와 잘못된 패스워드</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;badPassword&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when : 토큰 발급 시도</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>post</span><span class=p>(</span><span class=s>&#34;/jwt/token&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// then : 401(Unauthenticated) 오류</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>401</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;2. 정상 로그인 시 jwt를 발행한다.(Happy Case)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testLoginSuccess</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given : 정상 아이디, 패스워드</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user1234&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when : 토큰 발급</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>post</span><span class=p>(</span><span class=s>&#34;/jwt/token&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>200</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andReturn</span><span class=p>().</span><span class=na>getResponse</span><span class=p>().</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// then : 정상 토큰여부 확인(JwtUtil)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jwtUtil</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;3. 잘못된 jwt로 인증할 수 없다.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testAuthentication</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given : 잘못된 jwt 토큰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>badToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;bearer asdf1234&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when : User API 접근</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;/user/resources&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>AUTHORIZATION</span><span class=p>,</span><span class=w> </span><span class=n>badToken</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// then : 401 오류</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>401</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;4. 권한이 부족한 jwt에 인가할 수 없다.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testAuthorization</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given : User JWT 획득</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user1234&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>post</span><span class=p>(</span><span class=s>&#34;/jwt/token&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>200</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andReturn</span><span class=p>().</span><span class=na>getResponse</span><span class=p>().</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when : Admin API 접근</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;/admin/resources&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>AUTHORIZATION</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Bearer &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userToken</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// then : 403(Forbidden) 오류</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>403</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;5. 정상적인 jwt로 특정 권한의 api를 사용할 수 있다.`(Happy Case)`&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testHappyCase</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given : Admin JWT 획득</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;admin&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;admin1234&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>post</span><span class=p>(</span><span class=s>&#34;/jwt/token&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>param</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>200</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andReturn</span><span class=p>().</span><span class=na>getResponse</span><span class=p>().</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when : Admin API 접근</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;/admin/resources&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>AUTHORIZATION</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Bearer &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userToken</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// then : Admin 자원 획득</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>is</span><span class=p>(</span><span class=n>200</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>content</span><span class=p>().</span><span class=na>string</span><span class=p>(</span><span class=s>&#34;ADMIN 자원 획득&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>위 통합테스트를 작성하면서, 기존에 없던 <code>JWTUtil</code>이라는 클래스를 임시로 만들었습니다.</p><blockquote><p><code>TDD</code>를 하는 만큼 테스트 과정에서 필요한 클래스는 그때그때 만들면서 대응하는 것이 좋습니다.</p></blockquote><p>아직 세부사항은 전혀 구현되지 않았으나, 일단은 테스트를 실행할 수 있도록 컴파일 오류를 해결하기 위해 다음과 <code>utility</code> 패키지를 만들고, <code>JwtUtil</code> 클래스를 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.utility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtUtil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>통합테스트를 실행하면 다음과 같이 4개의 테스트가 실패합니다.</p><p><img alt="통합테스트 실패" loading=lazy src=/posts/spring_security/5/integration_test_failure.png></p><h3 id=jwtutil-단위테스트-작성>JwtUtil 단위테스트 작성<a hidden class=anchor aria-hidden=true href=#jwtutil-단위테스트-작성>#</a></h3><p>우선, 임시로 만든 <code>JwtUtil</code>클래스의 기능을 채우기 위해 단위테스트를 작성하겠습니다.</p><blockquote><p>처음에는 어색할 수 있지만, 테스트를 먼저 작성하고 구현하는 것에 익숙해져야 합니다.</p></blockquote><ul><li>이를 위해 요구사항을 분석하자면 다음과 같습니다.<ol><li>유효하지 않은 토큰 검증 시 런타임 오류를 반환한다.</li><li>유효한 토큰 검증 시 오류가 발생하지 않는다.<code>(Happy Case)</code></li><li>잘못된 권한의 토큰 발급 시 런타임 오류를 반환한다.</li><li>사용자 권한별 정상적인 토큰을 발급한다.<code>(Happy Case)</code></li><li>유효하지 않은 토큰 파싱 시 런타임 오류를 반환한다.</li><li>정상적인 토큰을 파싱한다.<code>(Happy Case)</code></li></ol><blockquote><p>토큰 검증 뿐 아니라, 토큰 API에서 사용할 권한별 토큰을 만드는 로직과 파싱하는 로직을 포함시켰습니다.</p></blockquote></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.utility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.BeforeEach</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.DisplayName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.Test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>org.assertj.core.api.Assertions.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>JwtUtilTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JwtUtil</span><span class=w> </span><span class=n>suit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// JWT 형식이 아닌 토큰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>invalidToken1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;INVALIDATE_TOKEN&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// https://jwt.io 에서 만든 예제 토큰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>invalidToken2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// sub : admin, role : admin 이지만 유효하지 않은 secret key 를 사용한 토큰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>invalidToken3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiJ9.wpTc_a19-bJNZ7oeYghAmxks3tk2mjcP6xTqYe2u86c&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@BeforeEach</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>suit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;1. 유효하지 않은 토큰 검증 시 런타임 오류를 반환한다.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testInvalidateToken</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>invalidToken1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>invalidToken2</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>invalidToken3</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;2. 유효한 토큰 검증 시 오류가 발생하지 않는다.(Happy Case)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testValidateToken</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// sub : admin, role : admin, 유효한 secret key 를 사용한 토큰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>validToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsInJvbGUiOiJBRE1JTiJ9.JPTeQnDLHeqqF2phvhfh_29tLucdzGWBDEeDyJhnmdk&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>suit</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>validToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;3. 잘못된 권한의 토큰 발급 시 런타임 오류를 반환한다.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testIllegalRoleIssue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;test_user&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ILLEGAL_ROLE&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>issue</span><span class=p>(</span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=n>role</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;4. 사용자 권한별 정상적인 토큰을 발급한다.(Happy Case)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testLegalRoleIssue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userRole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;USER&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>adminName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;admin&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>adminRole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ADMIN&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>issue</span><span class=p>(</span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=n>userRole</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>adminToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>issue</span><span class=p>(</span><span class=n>adminName</span><span class=p>,</span><span class=w> </span><span class=n>adminRole</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>suit</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>userToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>suit</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>adminToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;5. 유효하지 않은 토큰 파싱 시 런타임 오류를 반환한다.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testIllegalTokenParse</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseName</span><span class=p>(</span><span class=n>invalidToken1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseName</span><span class=p>(</span><span class=n>invalidToken2</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseName</span><span class=p>(</span><span class=n>invalidToken3</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseRole</span><span class=p>(</span><span class=n>invalidToken1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseRole</span><span class=p>(</span><span class=n>invalidToken2</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThatThrownBy</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseRole</span><span class=p>(</span><span class=n>invalidToken3</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>isInstanceOf</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;6. 정상적인 토큰을 파싱한다.(Happy Case)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testLegalTokenParse</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// given</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userRole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;USER&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>issue</span><span class=p>(</span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=n>userRole</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseName</span><span class=p>(</span><span class=n>userToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suit</span><span class=p>.</span><span class=na>parseRole</span><span class=p>(</span><span class=n>userToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>userName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>role</span><span class=p>).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>userRole</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>해시알고리즘과 같은 훨씬 구체적인 보안 요구사항이 있을 수 있지만, 예제인 만큼 전반적인 JWT의 동작 방식을 이해하는 것에 집중하겠습니다.</p></blockquote><h2 id=구현>구현<a hidden class=anchor aria-hidden=true href=#구현>#</a></h2><p>구현은 우선 단위테스트를 모두 성공한 후, 통합테스트를 완성시키는 순서로 진행하겠습니다.</p><h3 id=jwtutil-구현>JWTUtil 구현<a hidden class=anchor aria-hidden=true href=#jwtutil-구현>#</a></h3><p>우선 테스트를 실행하기 위해 다음과 같이 JwtUtil을 수정합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.utility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtUtil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>issue</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>Role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>parseRole</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>parseName</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>userToken</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이후 단위테스트 결과는 다음과 같습니다.</p><p><img alt="단위테스트 실패" loading=lazy src=/posts/spring_security/5/unittest_failure.png></p><blockquote><p>우선 토큰 검증부터 차근차근 구현해 보겠습니다.</p></blockquote><p>토큰 검증을 위해서 <a href=#jwt-%EC%9D%98%EC%A1%B4%EC%84%B1-%EC%B6%94%EA%B0%80>맨 처음에 추가했던</a> <code>jjwt</code> 라이브러리를 활용하겠습니다.</p><blockquote><p><a href="https://github.com/jwtk/jjwt?tab=readme-ov-file#verification-key"><code>jjwt 깃허브의 Readme</code></a>를 참고해서 다음과 같이 토큰을 검증하도록 했습니다.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JwtUtil.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jwts</span><span class=p>.</span><span class=na>parser</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>verifyWith</span><span class=p>(</span><span class=n>secretKey</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>parseSignedClaims</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>SecretKey</span><span class=w> </span><span class=nf>secretKey</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// https://randomkeygen.com/ 에서 생성한 504-bit WPA Key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Keys</span><span class=p>.</span><span class=na>hmacShaKeyFor</span><span class=p>(</span><span class=s>&#34;+*jhLeu04kw7M~tQew&lt;Ym&lt;d%,\&#34;{(PC$p64acJ}lH_;d:&#39;nD/^s+y7O=j!FBia5b&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>참고로 예제 프로젝트이므로 비밀키를 노출했지만, 실제 프로젝트라면 별도의 환경변수로 분리해서 노출되지 않도록 주의해야 합니다.</p></blockquote><p>이후 다음과 같이 검증 로직 테스트가 정상 동작합니다.</p><p><img alt="단위테스트 성공 1" loading=lazy src=/posts/spring_security/5/unittest_success_1.png></p><p>다음으로 토큰 발행 로직을 <a href="https://github.com/jwtk/jjwt?tab=readme-ov-file#creating-a-jwt">다음 페이지</a>를 참고하여 구현하였습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JwtUtil.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>issue</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>Role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>subject</span><span class=p>(</span><span class=n>userName</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>claim</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>,</span><span class=n>Role</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>signWith</span><span class=p>(</span><span class=n>secretKey</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>compact</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span></code></pre></div><p>이후 다음과 같이 발행 테스트의 <code>Happy Case</code>가 정상 동작하지만, <code>ADMIN</code> 혹은 <code>USER</code> 권한을 제외한 다른 권한은 사용할 수 없다는 3번 테스트는 실패합니다.</p><p><img alt="단위테스트 실패 2" loading=lazy src=/posts/spring_security/5/unittest_failure_2.png></p><p>이를 위해 <code>Role</code>을 담은 별도의 <code>enum</code>으로 분리하고 다음과 같이 메서드를 수정합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Role.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=n>Role</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USER</span><span class=p>,</span><span class=w> </span><span class=n>ADMIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isValid</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Role</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Role</span><span class=p>.</span><span class=na>values</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>name</span><span class=p>().</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>role</span><span class=p>))</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// JwtUtil.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>issue</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Role</span><span class=p>.</span><span class=na>isValid</span><span class=p>(</span><span class=n>role</span><span class=p>))</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EnumConstantNotPresentException</span><span class=p>(</span><span class=n>Role</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>role</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>subject</span><span class=p>(</span><span class=n>userName</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>claim</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>,</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>signWith</span><span class=p>(</span><span class=n>secretKey</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>compact</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략*/</span><span class=w>
</span></span></span></code></pre></div><p>이제 발행 메서드에 관한 모든 테스트가 성공합니다.</p><p><img alt="단위테스트 성공 2" loading=lazy src=/posts/spring_security/5/unittest_success_2.png></p><p>마지막으로 <a href="https://github.com/jwtk/jjwt?tab=readme-ov-file#reading-a-jwt">다음 페이지를 참고</a>하여 토큰 파싱 로직을 작성하였습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JwtUtil.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>parseName</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getPayload</span><span class=p>(</span><span class=n>token</span><span class=p>).</span><span class=na>getSubject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>parseRole</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>getPayload</span><span class=p>(</span><span class=n>token</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Claims</span><span class=w> </span><span class=nf>getPayload</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>parser</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>verifyWith</span><span class=p>(</span><span class=n>secretKey</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>parseSignedClaims</span><span class=p>(</span><span class=n>token</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getPayload</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이제 모든 단위 테스트가 성공합니다.</p><p><img alt="단위테스트 성공 3" loading=lazy src=/posts/spring_security/5/unittest_success_3.png></p><p>또한, <code>JwtUtil</code>의 커버리지를 분석해보면, 다음과 같이 모든 메서드가 테스트되고 있음을 알 수 있습니다.</p><p><img alt="단위 테스트 커버리지" loading=lazy src=/posts/spring_security/5/test_coverage.png></p><blockquote><p><code>JwtUtil</code>의 모든 메서드에 대한 단위테스트가 성공했기 때문에, 통합테스트에서는 세부적인 테스트를 작성하지 않아도 빠르게 유효성을 검증할 수 있습니다.</p></blockquote><h3 id=token-api-구현>Token API 구현<a hidden class=anchor aria-hidden=true href=#token-api-구현>#</a></h3><p>우선, 토큰을 발행하는 API를 다음과 같이 <code>APIController</code>에 생성하겠습니다.</p><blockquote><p>예제이므로, <code>Controller</code>에서 요청 정보를 모두 검증하도록 하겠습니다.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ApiController.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/jwt/token&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getToken</span><span class=p>(</span><span class=nd>@RequestParam</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>,</span><span class=w> </span><span class=nd>@RequestParam</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>password</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;user1234&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>jwtUtil</span><span class=p>.</span><span class=na>issue</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Role</span><span class=p>.</span><span class=na>USER</span><span class=p>.</span><span class=na>name</span><span class=p>()),</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>OK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>password</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;admin1234&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>jwtUtil</span><span class=p>.</span><span class=na>issue</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Role</span><span class=p>.</span><span class=na>ADMIN</span><span class=p>.</span><span class=na>name</span><span class=p>()),</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>OK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span></code></pre></div><p>하지만, 통합테스트를 실행해보면 여전히 3번 테스트를 제외하고는 모든 테스트가 실패하고 있습니다.</p><p><img alt="통합테스트 실패" loading=lazy src=/posts/spring_security/5/integration_test_failure_2.png></p><blockquote><p>테스트 실패 메시지를 확인해보면 <code>403</code> 오류가 발생하고 있는데, 이를 통해 <code>SecurityFilterChain</code>에서 해당 API를 차단하고 있음을 알 수 있습니다.</p></blockquote><p>따라서, 다음과 같이 해당 API를 모든 요청에 대해 승인하고, 매번 Test마다 CSRF 토큰을 요청에 포함하는 것이 번거로우니 CSRF도 해제하도록 하겠습니다.</p><p>또한, 지난 시간에 <code>SecurityConfig</code> 내부에 등록했던 <code>mvcHandlerMappingIntrospector</code>는 통합테스트에만 사용하기 때문에 <code>TestConfig</code> 내부로 이동하겠습니다.</p><p>마지막으로 통합테스트 내부에 <code>TestConfig</code>와 <code>JwtUtil</code>을 불러오고, <code>JwtUtil</code> 객체는 <code>init</code>메서드에서 생성자를 통해 새로 만들어줍니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// SecurityConfig.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>filterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>csrf</span><span class=p>(</span><span class=n>AbstractHttpConfigurer</span><span class=p>::</span><span class=n>disable</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizeHttpRequests</span><span class=p>(</span><span class=n>authorize</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>authorize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/public/**&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/user/**&#34;</span><span class=p>).</span><span class=na>hasRole</span><span class=p>(</span><span class=s>&#34;USER&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/admin/**&#34;</span><span class=p>).</span><span class=na>hasRole</span><span class=p>(</span><span class=s>&#34;ADMIN&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/jwt/token&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>formLogin</span><span class=p>(</span><span class=n>Customizer</span><span class=p>.</span><span class=na>withDefaults</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>exceptionHandling</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>authenticationEntryPoint</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CustomAuthenticationEntryPoint</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// src &gt; test &gt; java &gt; com &gt; springsecurity &gt; jwt &gt; config &gt; TestConfig.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.handler.HandlerMappingIntrospector</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;mvcHandlerMappingIntrospector&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>HandlerMappingIntrospector</span><span class=w> </span><span class=nf>mvcHandlerMappingIntrospector</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HandlerMappingIntrospector</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// JwtIntegrationTest.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ExtendWith</span><span class=p>(</span><span class=n>SpringExtension</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ContextConfiguration</span><span class=p>(</span><span class=n>classes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SecurityConfig</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@WebAppConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// JwtUtil, TestConfig 불러오기</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Import</span><span class=p>({</span><span class=n>ApiController</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>TestConfig</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JWTIntegrationTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MockMvc</span><span class=w> </span><span class=n>mockMvc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JwtUtil</span><span class=w> </span><span class=n>jwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WebApplicationContext</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@BeforeEach</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// JwtUtil 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jwtUtil</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MockMvcBuilders</span><span class=p>.</span><span class=na>webAppContextSetup</span><span class=p>(</span><span class=n>context</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>springSecurity</span><span class=p>()).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* 생략 */</span><span class=w>
</span></span></span></code></pre></div><p>위와 같이 수정 후 테스트를 돌려보면, 다음과 같이 1 ~ 3번 테스트가 성공합니다.</p><p><img alt="통합테스트 성공" loading=lazy src=/posts/spring_security/5/integration_test_success.png></p><h3 id=authentication-구현>Authentication 구현<a hidden class=anchor aria-hidden=true href=#authentication-구현>#</a></h3><p>4 ~ 5번 테스트가 실패하는 원인은 현재 <code>Authorization Header</code>의 <code>JWT</code>를 통해 권한 정보를 불러오는 기능을 만들지 않았기 때문입니다.</p><p>이를 구현하기 위해 <code>JWT</code>를 통해 권한을 가져오는 <code>AuthenticationFilter</code>와 <code>AuthenticationProvider</code>를 <code>SecurityFilterChain</code>에 등록해야 합니다.<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></p><p>다음과 같이 필요한 클래스들을 구현한 뒤, SecurityFilter에 등록합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JwtAuthenticationFilter.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.springsecurity.jwt.Role</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.springsecurity.jwt.utility.JwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.FilterChain</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.ServletException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.http.HttpServletRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.http.HttpServletResponse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.RequiredArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.http.HttpHeaders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.security.core.context.SecurityContextHolder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.filter.OncePerRequestFilter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtAuthenticationFilter</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>OncePerRequestFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JwtUtil</span><span class=w> </span><span class=n>jwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilterInternal</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>AUTHORIZATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>header</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>header</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>header</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>)</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtUtil</span><span class=p>.</span><span class=na>parseName</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtUtil</span><span class=p>.</span><span class=na>parseRole</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setAuthentication</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=p>.</span><span class=na>authenticated</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>SimpleGrantedAuthority</span><span class=p>(</span><span class=n>Role</span><span class=p>.</span><span class=na>getAuthority</span><span class=p>(</span><span class=n>role</span><span class=p>)))));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>해당 필터에서는 <code>request header</code>에 있는 토큰을 파싱하여 토큰에 명시된 권한이 있는 인증 객체를 생성하고, 이를 <code>SecurityContext</code>에 보관하는 역할을 수행합니다.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.springsecurity.jwt.config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.springsecurity.jwt.utility.JwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.RequiredArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.security.authentication.AuthenticationProvider</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.security.core.Authentication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.security.core.AuthenticationException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Arrays</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtAuthenticationProvider</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AuthenticationProvider</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JwtUtil</span><span class=w> </span><span class=n>jwtUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Authentication</span><span class=w> </span><span class=nf>authenticate</span><span class=p>(</span><span class=n>Authentication</span><span class=w> </span><span class=n>authentication</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>AuthenticationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>jwtUtil</span><span class=p>.</span><span class=na>validate</span><span class=p>((</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>authentication</span><span class=p>.</span><span class=na>getCredentials</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getStackTrace</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>authentication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>supports</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>authentication</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>해당 <code>Provider</code>는 <code>Credentials</code>을 검증하는 역할을 수행합니다. 사실 해당 과정은 토큰을 파싱하면서 이미 수행하기 때문에 반드시 성공하지만, <code>Spring Security</code>의 인증 과정을 학습하는 것이 목표임으로 별도로 분리했습니다.</p></blockquote><h2 id=결론>결론<a hidden class=anchor aria-hidden=true href=#결론>#</a></h2><h3 id=다음-포스팅>다음 포스팅<a hidden class=anchor aria-hidden=true href=#다음-포스팅>#</a></h3><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><table><thead><tr><th style=text-align:left>URL</th><th style=text-align:left>게시일자</th><th style=text-align:left>방문일자</th><th style=text-align:left>작성자</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://docs.spring.io/spring-security/reference/servlet/authentication/passwords>Spring 공식문서</a></td><td style=text-align:left>-</td><td style=text-align:left>2024.12.06.</td><td style=text-align:left>Spring</td></tr><tr><td style=text-align:left><a href=https://datatracker.ietf.org/doc/html/rfc7519>RFC 7519</a></td><td style=text-align:left>2015.05.</td><td style=text-align:left>2024.12.06.</td><td style=text-align:left>IETF</td></tr></tbody></table><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://ko.wikipedia.org/wiki/%EB%AC%B4%EC%83%81%ED%83%9C_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C><code>stateless</code></a>는 무상태 프로토콜을 뜻하며, 웹 통신의 기초인 HTTP 프로토콜도 이러한 특성을 가집니다. 서버에서 세션이나 기타 상태를 보관하지 않기 때문에 수평적인 확장(Scale-out)이 용이합니다.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://developer.mozilla.org/ko/docs/Web/HTTP/Cookies><code>cookie 저장소</code></a>는 서버가 클라이언트에게 전송하는 작은 데이터 조각입니다. 웹 브라우저와 같은 대부분의 클라이언트는 이를 별도의 저장소에 저장하고 있다가, 서버의 응답에 이를 포함하여 전송합니다.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://en.wikipedia.org/wiki/Scalability><code>Scale Out</code></a>은 수평적 확장을 뜻합니다. 많은 사용자(트래픽)들을 감당하기 위해 서버는 동일한 역할을 수행하는 여러 개의 작은 서버를 두고, 부하를 골고루 분산하여 이에 대응합니다.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://ko.wikipedia.org/wiki/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4><code>MSA</code></a>는 느슨하게 결합된 작은 서비스들을 구조화하여 큰 서비스를 수행하는 개발 기법입니다. 큰 애플리케이션을 작은 단위로 모듈화하여 작은 팀들이 독립적으로 서비스를 개발, 확장, 리팩터링 가능하게 합니다.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://auth0.com/docs/secure/tokens/refresh-tokens><code>refresh token</code></a>은 <code>access token</code>의 탈취를 대비하여 함께 발행하는 토큰입니다.</p><p><code>access token</code>이 탈취되면 해당 사용자의 권한이 모두 탈취되기 때문에, 이를 방지하기 위해 보통 토큰 만료시간을 짧게 설정합니다. 이러한 경우, 사용자는 매번 다시 인증과정을 거쳐 토큰을 발급받아야 하는데, 이러한 번거로움을 줄이기 위해 유효한 <code>Refresh Token</code>을 보유한 사용자는 즉시 <code>Access Token</code>을 재발급해줍니다.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>해당 인증 로직의 구체적인 아키텍쳐는 <a href=https://1eaf.site/posts/spring_security/3/#authentication>다음 포스트</a>를 참고하시기 바랍니다.&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/authentication/>Authentication</a></li><li><a href=http://localhost:1313/tags/jwt/>Jwt</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/cote/bj_9202/><span class=title>« 이전 페이지</span><br><span>[Java]백준 9202 Boggle</span>
</a><a class=next href=http://localhost:1313/posts/spring_security/4/><span class=title>다음 페이지 »</span><br><span>[Java]Spring Security(With TDD) 기본 인증 및 인가 구현하기</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on x" href="https://x.com/intent/tweet/?text=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f&amp;hashtags=authentication%2cjwt"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f&amp;title=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0&amp;summary=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f&title=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on whatsapp" href="https://api.whatsapp.com/send?text=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on telegram" href="https://telegram.me/share/url?text=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]Spring Security(With TDD) JWT 구현하기 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%5bJava%5dSpring%20Security%28With%20TDD%29%20JWT%20%ea%b5%ac%ed%98%84%ed%95%98%ea%b8%b0&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fspring_security%2f5%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://utteranc.es/client.js repo=leaf-nam/leaf-nam.github.io issue-term=title theme=boxy-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>봄을 기다리는 낙엽</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="복사";function s(){t.innerHTML="복사 완료!",setTimeout(()=>{t.innerHTML="복사"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>